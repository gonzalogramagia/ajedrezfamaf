---
import Layout from '../layouts/Layout.astro';
import StaticHero from '../components/StaticHero.astro';
import InstagramFloatingButton from '../components/InstagramFloatingButton.astro';
import GithubFloatingButton from '../components/GithubFloatingButton.astro';
import Badge from '../components/Badge.astro';
import Authors from '../components/Authors.astro';
import { getAllPosts } from '../lib/posts';
import { parseMarkdown } from '../lib/markdown';
import { getImageUrl } from '../lib/storage';
import wallpaper from '../assets/wallpaper.png';

const seoConfig = {
  title: "Ajedrez FAMAF",
  description: "⚡♟ Web oficial del taller de Ajedrez de FAMAF",
  og: {
    title: "Ajedrez FAMAF",
    description: "Un espacio para compartir novedades, noticias y eventos de la comunidad de ajedrez universitaria.",
    url: "https://ajedrezfamaf.com",
  },
};

// Función para convertir fecha YYYY-MM-DD a formato español
function formatDateToSpanish(dateString: string): string {
  const date = new Date(dateString);
  const months = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
  ];
  
  const day = date.getDate();
  const month = months[date.getMonth()];
  
  return `${day} de ${month}`;
}

// Obtener todos los posts desde Supabase (ya ordenados por el campo 'order')
const posts = await getAllPosts();
---

<Layout title={seoConfig.title} description={seoConfig.description}>
  <main 
    class="min-h-screen relative" 
    style={`background-image: url(${wallpaper.src}); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed;`}
  >
    <div style="position: absolute; inset: 0; background-color: white; opacity: 0.95; pointer-events: none;"></div>
    <div class="relative z-10">
    <StaticHero />
    <InstagramFloatingButton />
    <GithubFloatingButton mobileVisible={posts.length === 0} />
    {posts.length > 0 ? (
      <div class="lg:pr-56">
        <section
          class="relative mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 overflow-hidden"
        >
          <div class="grid gap-12 lg:gap-16">
            {posts.map((post) => (
              <article class="md:flex group">
                <div class="md:w-1/4 md:text-right md:pr-8 flex-shrink-0 pt-1">
                  <time datetime={post.date} class="hidden md:block font-medium text-gray-400 group-hover:text-orange-500 transition-colors mb-2">
                    {formatDateToSpanish(post.date)}
                  </time>
                  {post.date && (
                    <div class="hidden md:flex md:justify-end">
                      <Badge label={new Date(post.date).getFullYear().toString()} />
                    </div>
                  )}
                </div>
                
                <div class="md:w-3/4 md:pl-8 md:border-l md:border-gray-100 relative pb-12">
                  <div class="absolute -left-[6.5px] top-2.5 hidden md:block w-3 h-3 rounded-full border-2 border-white bg-gray-200 group-hover:bg-black transition-colors"></div>
                  
                  <h2 class="text-2xl font-bold text-gray-900 mb-2 hover:opacity-60 transition-opacity">
                    <a href={`/${post.slug}`} class="block">
                      {post.title}
                    </a>
                  </h2>

                  <div class="flex items-center gap-4 text-sm text-gray-500 mb-3 md:hidden">
                    <time datetime={post.date} class="font-medium text-orange-500 text-base">
                      {formatDateToSpanish(post.date)}
                    </time>
                    <div class="w-1 h-1 rounded-full bg-gray-300"></div>
                    {post.date && (
                      <Badge label={new Date(post.date).getFullYear().toString()} />
                    )}
                  </div>

                  {post.featured_image && (
                    <a href={`/${post.slug}`} class="block mb-4 overflow-hidden rounded-lg">
                      <img 
                        src={getImageUrl(post.featured_image)} 
                        alt={post.title}
                        class="w-full h-72 md:h-96 object-cover transform hover:scale-105 transition-transform duration-300"
                      />
                    </a>
                  )}
                  
                  <div class="prose prose-sm max-w-none text-gray-600 leading-relaxed mb-4 line-clamp-3" set:html={parseMarkdown(post.excerpt || post.content)}></div>
                  
                  <div class="flex items-center pt-2">
                    <a 
                      href={`/${post.slug}`}
                      class="inline-flex items-center text-primary font-semibold hover:text-secondary transition-colors group whitespace-nowrap"
                    >
                      Leer el artículo completo →
                      <svg class="w-4 h-4 ml-2 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                      </svg>
                    </a>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </section>
      </div>
    ) : (
      <div class="flex flex-col items-center justify-center pt-0 pb-48 text-center container mx-auto px-4">
        <div class="bg-orange-50 rounded-full p-4 mb-4">
          <svg class="w-12 h-12 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        </div>
        <p class="text-gray-600 max-w-md mx-auto">
          No se pudieron cargar las noticias. Por favor, verifica tu conexión o intenta nuevamente más tarde.
        </p>
      </div>
    )}
    
    <!-- Footer con Gonza -->
    <section class="relative mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 pt-8 pb-10 md:py-8">
      <div class:list={["md:text-center md:pl-0", { "text-center": posts.length === 0, "text-left pl-6": posts.length > 0 }]}>
        <p class="inline-flex items-center text-yellow-500 text-lg font-semibold">
          © 2026 | Mens sana in corpore sano
        </p>
      </div>
    </section>
    </div>
  </main>
</Layout>