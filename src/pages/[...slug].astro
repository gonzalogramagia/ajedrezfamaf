---
import Layout from '../layouts/Layout.astro';
import StaticHeader from '../components/StaticHeader.astro';
import StaticHeader from '../components/StaticHeader.astro';
import InstagramFloatingButton from '../components/InstagramFloatingButton.astro';
import GithubFloatingButton from '../components/GithubFloatingButton.astro';
import Badge from '../components/Badge.astro';
import Authors from '../components/Authors.astro';
import { getAllPosts } from '../lib/posts';
import { parseMarkdown } from '../lib/markdown';
import { getImageUrl } from '../lib/storage';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  
  return posts.map((post) => {
    // Verificar que el post tenga slug
    if (!post || !post.slug) {
      console.warn('Post sin slug o post inválido:', post?.title || 'Post desconocido');
      return null;
    }
    
    const slug = post.slug.replace(/^\d+\./, '');
    
    return {
      params: { slug },
      props: { post }
    };
  }).filter(Boolean); // Filtrar valores null
}

const { post } = Astro.props;

// Verificar que el post existe
if (!post) {
  return Astro.redirect('/404');
}

// Función para convertir fecha YYYY-MM-DD a formato español
function formatDateToSpanish(dateString: string): string {
  const date = new Date(dateString);
  const months = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
  ];
  
  const day = date.getDate();
  const month = months[date.getMonth()];
  
  return `${day} de ${month}`;
}
---

<Layout title={`${post.title} - Ajedrez FAMAF`} description={post.title}>
  <main 
    class="post-main" 
    style="background-image: url('/wallpaper.png'); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed;"
  >
    <div style="position: absolute; inset: 0; background-color: white; opacity: 0.95; pointer-events: none;"></div>
    <div class="relative z-10">
    <InstagramFloatingButton />
    <GithubFloatingButton />
    
    <StaticHeader />
    
    <div class="post-content">
      <article class="post-article">
        <!-- Botones duplicados arriba del título -->
        <div class="post-header-actions">
          <a href="/" class="back-link">
            <svg class="back-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Volver al inicio
          </a>
          
          <button id="copyButtonTop" class="copy-button">
            <svg id="copyIconTop" class="copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <span id="copyTextTop">Copiar URL</span>
          </button>
        </div>

        <div class="post-header-info">
          <h1 class="post-title">{post.title}</h1>
               <div class="post-meta">
                 <span class="post-date text-orange-500">{formatDateToSpanish(post.date)}</span>
                 <Badge label={new Date(post.date).getFullYear().toString()} />
               </div>
        </div>
        
        <div class="post-body" set:html={parseMarkdown(post.content)} />
        
        {post.featured_image && (
          <div class="post-featured-image mt-8">
            <img 
              src={getImageUrl(post.featured_image)} 
              alt={post.title}
              class="w-full h-[32rem] md:h-[40rem] object-cover rounded-lg"
            />
          </div>
        )}
        
        <div class="post-footer">
          <a href="/" class="back-link">
            <svg class="back-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Volver al inicio
          </a>
          
          <button id="copyButton" class="copy-button">
            <svg id="copyIcon" class="copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <span id="copyText">Copiar URL</span>
          </button>
        </div>
      </article>
    </div>
    
    <!-- Footer con Gonza -->
    <section class="post-footer-section pt-10 pb-12 md:py-8">
      <div class="post-footer-content text-left md:text-center">
        <p class="inline-flex items-center text-yellow-500 text-lg font-semibold">
          © 2026 | Mens sana in corpore sano
        </p>
      </div>
    </section>
    </div>
  </main>
</Layout>

<script>
  // Función para copiar la URL
  function setupCopyButton(buttonId, iconId, textId) {
    const copyButton = document.getElementById(buttonId);
    const copyIcon = document.getElementById(iconId);
    const copyText = document.getElementById(textId);
    
    copyButton?.addEventListener('click', async () => {
      try {
        const baseUrl = window.location.origin + window.location.pathname;
        await navigator.clipboard.writeText(baseUrl);
        
        // Cambiar el texto e ícono temporalmente
        copyText.textContent = '¡Copiado!';
        copyIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
        copyButton.classList.add('text-green-600', 'border-green-400');
        
        setTimeout(() => {
          copyText.textContent = 'Copiar URL';
          copyIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>';
          copyButton.classList.remove('text-green-600', 'border-green-400');
        }, 2000);
      } catch (err) {
        console.error('Error al copiar URL:', err);
      }
    });
  }

  // Configurar ambos botones de copiar
  setupCopyButton('copyButton', 'copyIcon', 'copyText');
  setupCopyButton('copyButtonTop', 'copyIconTop', 'copyTextTop');

  // Forzar espaciado en imágenes
  document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.post-body img');
    images.forEach(img => {
      img.style.marginTop = '2rem';
      img.style.marginBottom = '1.5rem';
      img.style.display = 'block';
      img.style.borderRadius = '12px';
    });

    // Forzar espaciado en párrafos que contienen imágenes
    const paragraphsWithImages = document.querySelectorAll('.post-body p:has(img)');
    paragraphsWithImages.forEach(p => {
      p.style.marginTop = '2rem';
      p.style.marginBottom = '1.5rem';
    });
  });
</script>

<style>
  .post-main {
    min-height: 100vh;
    position: relative;
  }

  .post-content {
    position: relative;
    margin-left: auto;
    margin-right: auto;
    max-width: 56rem;
    padding-left: 1rem;
    padding-right: 1rem;
    padding-top: 0.5rem;
    padding-bottom: 2rem;
  }

  @media (min-width: 640px) {
    .post-content {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
      padding-top: 2rem;
    }
  }

  @media (min-width: 1024px) {
    .post-content {
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }

  .post-article {
    max-width: none;
  }

  .post-header-actions {
    margin-top: -5.5rem;
    margin-bottom: 3rem;
    padding-top: 2.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .post-header-info {
    margin-bottom: 2rem;
  }

  .post-title {
    font-size: 2.25rem;
    font-weight: 700;
    margin-bottom: 1rem;
    margin-top: 0;
    line-height: 1.2;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #6b7280;
    margin-bottom: 1.5rem;
  }

  .post-date {
    font-weight: 600;
  }

  .post-body {
    max-width: none;
    color: #334155;
    line-height: 1.7;
  }

  .post-body h3 {
    margin-bottom: 1rem;
    font-size: 1rem;
    line-height: 1.5rem;
    font-weight: 600;
  }

  .post-body a {
    font-weight: 600;
    color: #0ea5e9;
    text-decoration: none;
  }

  .post-body a:hover {
    color: #0284c7;
  }

  .post-body p {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }

  .post-body img {
    max-width: 100%;
    height: auto;
    margin-top: 2rem !important;
    margin-bottom: 1.5rem !important;
    display: block;
    border-radius: 12px;
  }

  /* Espaciado para párrafos que contienen solo imágenes */
  .post-body p:has(img) {
    margin-top: 2rem !important;
    margin-bottom: 1.5rem !important;
  }

  /* Espaciado para párrafos que preceden a párrafos con imágenes */
  .post-body p:not(:has(img)) + p:has(img) {
    margin-bottom: 2rem !important;
  }

  /* Espaciado general para párrafos */
  .post-body p {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }

  .post-body p:first-of-type {
    margin-top: 0;
  }

  .post-body a[href^="http"] {
    target: _blank;
  }

  .post-footer {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  @media (max-width: 639px) {
    .post-footer .copy-button {
      display: none;
    }
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    color: #0ea5e9;
    text-decoration: none;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: #0284c7;
  }

  .back-icon {
    width: 1rem;
    height: 1rem;
    margin-right: 0.5rem;
  }

  .copy-button {
    display: inline-flex;
    align-items: center;
    color: #0ea5e9;
    background: none;
    border: 1px solid #38bdf8;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-button:hover {
    color: #0284c7;
    border-color: #0284c7;
  }

  .copy-icon {
    width: 1rem;
    height: 1rem;
    margin-right: 0.5rem;
  }

  .post-footer-section {
    position: relative;
    margin-left: auto;
    margin-right: auto;
    max-width: 64rem;
    padding-left: 1rem;
    padding-right: 1rem;
    padding-top: 2rem;
    padding-bottom: 2rem;
    margin-top: 2rem;
  }

  @media (min-width: 640px) {
    .post-footer-section {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .post-footer-section {
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }

  .post-footer-content {
    /* text-align managed by utility classes */
  }

  .gonza-link {
    display: inline-flex;
    align-items: center;
    color: #eab308;
    text-decoration: none;
    font-size: 1.125rem;
    line-height: 1.75rem;
    transition: all 0.2s;
  }

  .gonza-link:hover {
    transform: scale(1.01);
  }
</style>
